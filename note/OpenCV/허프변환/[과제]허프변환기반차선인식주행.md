# 과제

> 실제 트랙에서 차선을 벗어나지 않고 주행
>
> 카메라로 촬영한 차량 전방의 도로 영상을 opencv를 이용하여 허프변환 기반으로 차선을 찾고 양쪽 차선의 위치를 따져서 핸들을 얼마나 꺾을지 조향각을 결정

+ 차선 인식 주행을 위해 필요한 것들
  + 카메라 입력 데이터에서 프레임을 취득하기
  + 얻어낸 영상 데이터를 처리하여 차선위치를 결정
    + BGR -> GrayScale
    + canny함수로 임계값 범위를 주고 외곽선 추출
    + 관심영역 잘라내기
  + 차선 검출
    + 허프변환으로 직선 찾기
    + 양쪽 차선을 나타내는 평균 직선 구하기
    + 수평선 긋고 양쪽 직선과의 교점 좌표 구하기
  + 차선 위치를 기준으로 조향각 결정
    + 차선 중앙으로 차량이 달릴 수 있도록 조절
  + 결정한 조향각에 따라 조향 모터를 제어
    + 모터제어 토픽을 발행하기

## 허프변환을 이용한 차선 찾기

소스코드 프로세스 순서

1. 카메라 영상 신호에서 이미지 프레임 획득
2. 영상 프레임을 opencv함수로 처리
   + 흑백이미지 변환
   + 노이즈 제거
   + canny 사용
   + ROI 영역 만들기
3. 선분 검출
4. 차선 위치를 찾고 화면 중앙에서 어느 쪽으로 치우쳤는지 파악
5. 조향각 조절

## 작업 패키지

```bash
$ catkin_create_pkg hough_drive std_msgs rospy
```

```
Directory tree
src
	hough_drive
		launch
			hough_drive.launch
        src
        	hough_drive.py
        	steer_arrow.png
```

### hough_drive.launch

```xml
<launch>
	<!-- 노드 실행 : 자이카 모터 제어기 구동 -->
    <!-- 노드 실행 : 자이카 카메라 구동 -->
    <!-- 노드 실행 : 허프변환 기반 차선인식주행프로그램 실행 -->
</launch>
```

### hough_drive.py

```python
1. 카메라 영상 신호에서 이미지 프레임 획득
2. 영상 프레임을 opencv함수로 처리
   + 흑백이미지 변환
   + 노이즈 제거 (gaussian blur)
   + canny 사용
   + ROI 영역 만들기
3. 선분 검출
4. 차선 위치를 찾고 화면 중앙에서 어느 쪽으로 치우쳤는지 파악
5. 조향각 조절
```

## 카메라 자세 조정

카메라 자세를 정확하게 세팅할 때 사용

카메라 촬영 영상을 화면에 표시해준다.



## 차선 찾기

+ 왼쪽 차선을 잃어버린 경우
+ 오른쪽 차선을 잃어버린 경우
+ 양쪽 차선을 모두 잃어버린 경우

+ 한쪽 차선을 찾으면 거기서 일정 거리만큼 떨어져 다른 차선이 있을 수 있다.
+ 직선의 경우와 곡선의 경우는 차선 간격이 다르다

## 조향 및 속도 제어

+ 조향각 제어
  + 직선 차로면 정면으로 직진
  + 곡선 차로면 차로가 휘어진 방향으로 조향
  + 인식된 양쪽 차선 위치의 중점과 화면의 가운데에 위치했는지 아니면 얼마나 떨어져 있는지에 따라 조향 정도를 설정한다. 픽셀은 얼마인지 확인한다.
  + 양쪽 차선을 표시하는 직선을 연장해서 긋고 그 교점의 X좌표값을 구한다. 해당 좌표값이 중앙과 얼마나 떨어져있는지에 따라 조향 정도를 설정한다.
+ 속도 제어
  + 직선 주로에서는 빠르게
  + 곡선 주로에서는 적절히 느리게